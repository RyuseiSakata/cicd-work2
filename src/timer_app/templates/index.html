<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timer App (Smooth Render Version)</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 720px;
      margin: 40px auto;
      padding: 0 16px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    button {
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
    }

    .panel {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
    }

    .big {
      font-size: 44px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .muted {
      color: #666;
    }

    ul {
      padding-left: 18px;
    }
  </style>
</head>

<body>

  <h1>Timer App (Smooth Render Ver.)</h1>

  <div class="panel">
    <div class="muted">State: <span id="state">-</span></div>
    <div class="big" id="time">00:00.000</div>

    <div class="row">
      <button id="start">Start</button>
      <button id="stop">Stop</button>
      <button id="lap">Lap</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <h2>Laps</h2>
  <div class="panel">
    <ul id="laps"></ul>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    /* -----------------------------------
       ローカル状態（表示用）
    ----------------------------------- */
    let running = false;

    // 表示に使う値（常に滑らかに変化）
    let displayTime = 0;

    // API の理論上の値（目標値）
    let targetTime = 0;

    // smoothing の強さ（0.0〜1.0）
    const SMOOTH_FACTOR = 0.15;

    /* -----------------------------------
       フォーマット
    ----------------------------------- */
    function fmt(ms) {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      const r = ms % 1000;
      return String(m).padStart(2, '0') + ":" +
        String(s).padStart(2, '0') + "." +
        String(r).padStart(3, '0');
    }

    /* -----------------------------------
       API wrapper
    ----------------------------------- */
    async function api(path, method = "GET") {
      const res = await fetch(path, { method });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) throw { status: res.status, body };
      return body;
    }

    /* -----------------------------------
       500msごとに API の値を取得して "targetTime" に反映
    ----------------------------------- */
    async function refresh() {
      const t = await api("/timer");

      $("state").textContent = t.state;

      running = (t.state === "running");

      // APIの値をそのまま画面に使わず、"目標値" としてセットする
      targetTime = t.elapsed_ms;

      // ラップ一覧更新
      const ul = $("laps");
      ul.innerHTML = "";
      for (const lap of t.laps) {
        const li = document.createElement("li");
        li.textContent =
          `#${lap.lap_index} lap=${fmt(lap.lap_elapsed_ms)} total=${fmt(lap.total_elapsed_ms)}`;
        ul.appendChild(li);
      }
    }

    /* -----------------------------------
       requestAnimationFrame で
       displayTime → targetTime に滑らかに追いつく
    ----------------------------------- */
    let lastFrame = performance.now();

    function renderLoop(now) {
      const dt = now - lastFrame;
      lastFrame = now;

      if (running) {
        // running 中は targetTime を「リアル時間として進める」
        targetTime += dt;
      }

      // smoothing: displayTime が targetTime にゆっくり追いつく
      displayTime += (targetTime - displayTime) * SMOOTH_FACTOR;

      $("time").textContent = fmt(Math.floor(displayTime));

      requestAnimationFrame(renderLoop);
    }
    requestAnimationFrame(renderLoop);

    /* -----------------------------------
       ボタン操作
    ----------------------------------- */
    $("start").onclick = async () => { try { await api("/timer/start", "POST"); } catch (e) { } await refresh(); };
    $("stop").onclick = async () => { try { await api("/timer/stop", "POST"); } catch (e) { } await refresh(); };
    $("lap").onclick = async () => { try { await api("/timer/lap", "POST"); } catch (e) { } await refresh(); };
    $("reset").onclick = async () => { try { await api("/timer/reset", "POST"); } catch (e) { } await refresh(); };

    // 初期取得 & Render と同期（500msで十分）
    setInterval(refresh, 500);
    refresh();
  </script>
</body>

</html>
